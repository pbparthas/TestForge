// TestForge Database Schema
// Using Prisma with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USERS & AUTH
// =============================================================================

enum UserRole {
  admin
  lead
  qae
  dev
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         UserRole @default(qae)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  createdProjects       Project[]            @relation("ProjectCreator")
  createdTestCases      TestCase[]           @relation("TestCaseCreator")
  createdScripts        Script[]             @relation("ScriptCreator")
  triggeredExecutions   Execution[]          @relation("ExecutionTriggerer")
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]
  scriptSmithSessions   ScriptSmithSession[]
  quarantinedFlakyTests FlakyTest[]          @relation("FlakyQuarantiner")
  fixedFlakyTests       FlakyTest[]          @relation("FlakyFixer")
  chatConversations     ChatConversation[]
  helpFeedback          HelpFeedback[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// =============================================================================
// PROJECTS
// =============================================================================

enum Framework {
  playwright
  cypress
}

enum Language {
  typescript
  javascript
}

model Project {
  id            String    @id @default(uuid())
  name          String
  description   String?
  repositoryUrl String?   @map("repository_url")
  framework     Framework @default(playwright)
  language      Language  @default(typescript)
  createdById   String    @map("created_by_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  createdBy            User                  @relation("ProjectCreator", fields: [createdById], references: [id])
  requirements         Requirement[]
  testCases            TestCase[]
  testSuites           TestSuite[]
  scripts              Script[]
  environments         Environment[]
  devices              Device[]
  executions           Execution[]
  bugs                 Bug[]
  aiUsage              AiUsage[]
  scriptSmithSessions  ScriptSmithSession[]
  flakyTests           FlakyTest[]
  flakyPatterns        FlakyPattern[]
  duplicateChecks      DuplicateCheck[]
  jenkinsIntegrations  JenkinsIntegration[]

  @@map("projects")
}

// =============================================================================
// REQUIREMENTS
// =============================================================================

enum Priority {
  low
  medium
  high
  critical
}

enum Status {
  active
  inactive
  archived
}

model Requirement {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  externalId  String?  @map("external_id") // Jira/external system ID
  title       String
  description String?
  priority    Priority @default(medium)
  status      Status   @default(active)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCases TestCase[]

  @@index([projectId])
  @@index([externalId])
  @@map("requirements")
}

// =============================================================================
// TEST CASES
// =============================================================================

enum TestType {
  functional
  integration
  e2e
  api
  performance
}

model TestCase {
  id             String   @id @default(uuid())
  projectId      String   @map("project_id")
  requirementId  String?  @map("requirement_id")
  title          String
  description    String?
  preconditions  String?
  steps          Json     @default("[]") // Array of TestStep
  expectedResult String?  @map("expected_result")
  testData       Json?    @map("test_data")
  priority       Priority @default(medium)
  status         Status   @default(active)
  type           TestType @default(functional)
  isAutomated    Boolean  @default(false) @map("is_automated")
  createdById    String   @map("created_by_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requirement Requirement?      @relation(fields: [requirementId], references: [id], onDelete: SetNull)
  createdBy   User              @relation("TestCaseCreator", fields: [createdById], references: [id])
  scripts     Script[]
  suites      TestSuiteCase[]
  results     ExecutionResult[]
  bugs        Bug[]
  flakyTests  FlakyTest[]

  @@index([projectId])
  @@index([requirementId])
  @@map("test_cases")
}

// =============================================================================
// TEST SUITES
// =============================================================================

model TestSuite {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCases  TestSuiteCase[]
  executions Execution[]

  @@index([projectId])
  @@map("test_suites")
}

model TestSuiteCase {
  suiteId    String @map("suite_id")
  testCaseId String @map("test_case_id")
  orderIndex Int    @default(0) @map("order_index")

  // Relations
  suite    TestSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  testCase TestCase  @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@id([suiteId, testCaseId])
  @@map("test_suite_cases")
}

// =============================================================================
// SCRIPTS
// =============================================================================

enum ScriptStatus {
  draft
  review
  approved
  deprecated
}

model Script {
  id          String       @id @default(uuid())
  testCaseId  String       @map("test_case_id")
  projectId   String       @map("project_id")
  name        String
  code        String
  language    Language     @default(typescript)
  framework   Framework    @default(playwright)
  version     Int          @default(1)
  status      ScriptStatus @default(draft)
  generatedBy String?      @map("generated_by") // 'scriptsmith', 'manual', 'framework_agent'
  createdById String       @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  testCase   TestCase          @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy  User              @relation("ScriptCreator", fields: [createdById], references: [id])
  results    ExecutionResult[]
  flakyTests FlakyTest[]

  @@index([testCaseId])
  @@index([projectId])
  @@map("scripts")
}

// =============================================================================
// ENVIRONMENTS & DEVICES
// =============================================================================

model Environment {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  name      String
  baseUrl   String   @map("base_url")
  variables Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  executions Execution[]

  @@index([projectId])
  @@map("environments")
}

enum DeviceType {
  browser
  mobile
  tablet
}

model Device {
  id        String     @id @default(uuid())
  projectId String     @map("project_id")
  name      String
  type      DeviceType
  config    Json // Browser/device configuration
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("devices")
}

// =============================================================================
// EXECUTIONS
// =============================================================================

enum ExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

enum TriggerType {
  manual
  scheduled
  ci
}

model Execution {
  id            String          @id @default(uuid())
  projectId     String          @map("project_id")
  suiteId       String?         @map("suite_id")
  environmentId String?         @map("environment_id")
  status        ExecutionStatus @default(pending)
  triggerType   TriggerType     @default(manual) @map("trigger_type")
  startedAt     DateTime?       @map("started_at")
  completedAt   DateTime?       @map("completed_at")
  summary       Json? // Execution summary stats
  triggeredById String?         @map("triggered_by_id")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  suite       TestSuite?        @relation(fields: [suiteId], references: [id], onDelete: SetNull)
  environment Environment?      @relation(fields: [environmentId], references: [id])
  triggeredBy User?             @relation("ExecutionTriggerer", fields: [triggeredById], references: [id])
  results     ExecutionResult[]

  @@index([projectId])
  @@index([suiteId])
  @@map("executions")
}

enum ResultStatus {
  passed
  failed
  skipped
  error
}

model ExecutionResult {
  id                 String       @id @default(uuid())
  executionId        String       @map("execution_id")
  testCaseId         String?      @map("test_case_id")
  scriptId           String?      @map("script_id")
  status             ResultStatus
  durationMs         Int?         @map("duration_ms")
  errorMessage       String?      @map("error_message")
  errorStack         String?      @map("error_stack")
  screenshots        Json         @default("[]")
  videoUrl           String?      @map("video_url")
  logs               String?
  selfHealingApplied Boolean      @default(false) @map("self_healing_applied")
  createdAt          DateTime     @default(now()) @map("created_at")

  // Relations
  execution Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  testCase  TestCase? @relation(fields: [testCaseId], references: [id])
  script    Script?   @relation(fields: [scriptId], references: [id])

  @@index([executionId])
  @@map("execution_results")
}

// =============================================================================
// BUGS
// =============================================================================

enum BugStatus {
  open
  in_progress
  resolved
  closed
  wont_fix
}

model Bug {
  id                String    @id @default(uuid())
  projectId         String    @map("project_id")
  externalId        String?   @map("external_id") // Bugzilla ID
  title             String
  description       String?
  status            BugStatus @default(open)
  priority          Priority?
  linkedTestCaseId  String?   @map("linked_test_case_id")
  linkedExecutionId String?   @map("linked_execution_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCase TestCase? @relation(fields: [linkedTestCaseId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([externalId])
  @@map("bugs")
}

// =============================================================================
// AI COST TRACKING
// =============================================================================

model AiUsage {
  id           String   @id @default(uuid())
  projectId    String   @map("project_id")
  userId       String?  @map("user_id")
  agent        String // Agent name
  operation    String // Operation performed
  model        String // Model used
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  cachedTokens Int      @default(0) @map("cached_tokens")
  costUsd      Decimal  @map("cost_usd") @db.Decimal(10, 6)
  costInr      Decimal  @map("cost_inr") @db.Decimal(10, 4)
  durationMs   Int?     @map("duration_ms")
  success      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@map("ai_usage")
}

// =============================================================================
// SCRIPTSMITH SESSIONS (Sprint 13)
// =============================================================================

enum ScriptSmithInputMethod {
  record
  upload
  screenshot
  describe
  edit
}

enum ScriptSmithSessionStatus {
  created
  input_received
  analyzing
  transforming
  reviewing
  completed
  failed
}

enum ScriptSmithFileType {
  test
  page_object
  utility
  fixture
}

model ScriptSmithSession {
  id                String                   @id @default(uuid())
  userId            String                   @map("user_id")
  projectId         String?                  @map("project_id")
  inputMethod       ScriptSmithInputMethod   @map("input_method")
  status            ScriptSmithSessionStatus @default(created)
  rawInput          Json?                    @map("raw_input")
  transformedScript String?                  @map("transformed_script")
  frameworkAnalysis Json?                    @map("framework_analysis")
  costEstimate      Decimal?                 @map("cost_estimate") @db.Decimal(10, 4)
  projectPath       String?                  @map("project_path")
  deviceType        String?                  @map("device_type")
  deviceConfig      Json?                    @map("device_config")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")
  completedAt       DateTime?                @map("completed_at")

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  files           ScriptSmithFile[]
  duplicateChecks DuplicateCheck[]

  @@index([userId])
  @@index([status])
  @@index([projectId])
  @@map("scriptsmith_sessions")
}

model ScriptSmithFile {
  id        String              @id @default(uuid())
  sessionId String              @map("session_id")
  filePath  String              @map("file_path")
  fileType  ScriptSmithFileType @map("file_type")
  content   String
  imports   String[]            @default([])
  exports   String[]            @default([])
  createdAt DateTime            @default(now()) @map("created_at")

  // Relations
  session ScriptSmithSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("scriptsmith_files")
}

// =============================================================================
// WORKFLOW EXECUTIONS (Sprint 12 - TestPilot)
// =============================================================================

enum WorkflowExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

model Workflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  steps       Json // Workflow step definitions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  executions WorkflowExecution[]

  @@map("workflows")
}

model WorkflowExecution {
  id           String                  @id @default(uuid())
  workflowId   String                  @map("workflow_id")
  status       WorkflowExecutionStatus @default(pending)
  input        Json?
  output       Json?
  error        String?
  totalCostUsd Decimal?                @map("total_cost_usd") @db.Decimal(10, 4)
  startedAt    DateTime?               @map("started_at")
  completedAt  DateTime?               @map("completed_at")
  createdAt    DateTime                @default(now()) @map("created_at")

  // Relations
  workflow Workflow                @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  steps    WorkflowExecutionStep[]

  @@index([workflowId])
  @@index([status])
  @@map("workflow_executions")
}

model WorkflowExecutionStep {
  id          String    @id @default(uuid())
  executionId String    @map("execution_id")
  stepId      String    @map("step_id")
  status      String
  input       Json?
  output      Json?
  error       String?
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  execution WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@map("workflow_execution_steps")
}

// =============================================================================
// FLAKY TESTS (Sprint 14)
// =============================================================================

enum FlakyPatternType {
  timing
  race_condition
  flaky_selector
  network
  state_dependent
  environment
  data_dependent
  unknown
}

enum FlakyFixStatus {
  open
  investigating
  fixed
  wont_fix
}

model FlakyTest {
  id                String          @id @default(uuid())
  projectId         String          @map("project_id")
  testCaseId        String?         @map("test_case_id")
  scriptId          String?         @map("script_id")
  testName          String          @map("test_name")
  flakinessScore    Decimal         @default(0) @map("flakiness_score") @db.Decimal(5, 2) // 0-100
  totalRuns         Int             @default(0) @map("total_runs")
  passCount         Int             @default(0) @map("pass_count")
  failCount         Int             @default(0) @map("fail_count")
  lastPassAt        DateTime?       @map("last_pass_at")
  lastFailAt        DateTime?       @map("last_fail_at")
  isQuarantined     Boolean         @default(false) @map("is_quarantined")
  quarantinedAt     DateTime?       @map("quarantined_at")
  quarantinedById   String?         @map("quarantined_by_id")
  quarantineReason  String?         @map("quarantine_reason")
  patternType       FlakyPatternType? @map("pattern_type")
  rootCauseAnalysis Json?           @map("root_cause_analysis")
  fixStatus         FlakyFixStatus  @default(open) @map("fix_status")
  fixedAt           DateTime?       @map("fixed_at")
  fixedById         String?         @map("fixed_by_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCase      TestCase? @relation(fields: [testCaseId], references: [id], onDelete: SetNull)
  script        Script?   @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  quarantinedBy User?     @relation("FlakyQuarantiner", fields: [quarantinedById], references: [id])
  fixedBy       User?     @relation("FlakyFixer", fields: [fixedById], references: [id])

  @@unique([projectId, testCaseId, scriptId])
  @@index([projectId])
  @@index([flakinessScore(sort: Desc)])
  @@index([isQuarantined])
  @@index([fixStatus])
  @@map("flaky_tests")
}

enum FlakyPatternSeverity {
  critical
  high
  medium
  low
}

model FlakyPattern {
  id              String               @id @default(uuid())
  projectId       String               @map("project_id")
  patternType     FlakyPatternType     @map("pattern_type")
  description     String
  severity        FlakyPatternSeverity
  affectedTestIds String[]             @map("affected_test_ids")
  confidence      Decimal              @db.Decimal(5, 2) // 0-100
  suggestedFix    String?              @map("suggested_fix")
  detectedAt      DateTime             @default(now()) @map("detected_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([patternType])
  @@map("flaky_patterns")
}

// =============================================================================
// DUPLICATE DETECTION (Sprint 14)
// =============================================================================

enum DuplicateSourceType {
  test_case
  script
  session
}

enum DuplicateMatchType {
  exact
  near
  semantic
}

model DuplicateCheck {
  id           String               @id @default(uuid())
  projectId    String               @map("project_id")
  sessionId    String?              @map("session_id")
  sourceType   DuplicateSourceType  @map("source_type")
  sourceId     String               @map("source_id")
  contentHash  String?              @map("content_hash") // For exact match detection
  isDuplicate  Boolean              @default(false) @map("is_duplicate")
  confidence   Decimal?             @db.Decimal(5, 2) // 0-100
  matchType    DuplicateMatchType?  @map("match_type")
  similarItems Json?                @map("similar_items") // [{id, name, similarity, path}]
  reason       String?
  checkedAt    DateTime             @default(now()) @map("checked_at")

  // Relations
  project Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  session ScriptSmithSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([sourceType, sourceId])
  @@index([contentHash])
  @@map("duplicate_checks")
}

// =============================================================================
// JENKINS INTEGRATION (Sprint 15)
// =============================================================================

enum JenkinsBuildStatus {
  pending
  building
  success
  failure
  aborted
}

model JenkinsIntegration {
  id                  String   @id @default(uuid())
  projectId           String   @map("project_id")
  integrationName     String   @map("integration_name")
  serverUrl           String   @map("server_url")
  username            String
  apiTokenEncrypted   String   @map("api_token_encrypted") // AES-256 encrypted
  jobPath             String   @map("job_path")
  defaultEnvironment  String?  @map("default_environment")
  defaultBrowser      String?  @map("default_browser")
  buildParameters     Json?    @map("build_parameters")
  isActive            Boolean  @default(true) @map("is_active")
  createdById         String?  @map("created_by_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project  Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  builds   JenkinsBuild[]

  @@index([projectId])
  @@map("jenkins_integrations")
}

model JenkinsBuild {
  id                 String             @id @default(uuid())
  integrationId      String             @map("integration_id")
  executionId        String?            @map("execution_id")
  jenkinsBuildNumber Int                @map("jenkins_build_number")
  jenkinsBuildUrl    String             @map("jenkins_build_url")
  status             JenkinsBuildStatus @default(pending)
  parameters         Json?
  startedAt          DateTime?          @map("started_at")
  completedAt        DateTime?          @map("completed_at")
  durationMs         Int?               @map("duration_ms")
  totalTests         Int?               @map("total_tests")
  passedTests        Int?               @map("passed_tests")
  failedTests        Int?               @map("failed_tests")
  consoleLogUrl      String?            @map("console_log_url")
  createdAt          DateTime           @default(now()) @map("created_at")

  // Relations
  integration JenkinsIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([executionId])
  @@index([status])
  @@map("jenkins_builds")
}

// =============================================================================
// CHAT SYSTEM (Sprint 16)
// =============================================================================

enum ChatConversationStatus {
  active
  closed
  archived
}

enum ChatMessageRole {
  user
  assistant
  system
}

enum ChatSuggestionType {
  code_change
  config_change
  test_case
  script
  fix_suggestion
  explanation
  navigation
}

enum ChatSuggestionStatus {
  pending
  acknowledged
  dismissed
}

enum ChatConversationCategory {
  help_question
  feature_request
  bug_report
}

enum HelpFeedbackType {
  bug
  feature
  question
  other
}

enum HelpFeedbackStatus {
  new_feedback
  reviewed
  resolved
}

model ChatConversation {
  id          String                      @id @default(uuid())
  userId      String                      @map("user_id")
  projectId   String?                     @map("project_id")
  contextType String?                     @map("context_type") // page, test_case, script, etc.
  contextId   String?                     @map("context_id")
  title       String?
  category    ChatConversationCategory    @default(help_question)
  status      ChatConversationStatus      @default(active)
  createdAt   DateTime                    @default(now()) @map("created_at")
  updatedAt   DateTime                    @updatedAt @map("updated_at")
  closedAt    DateTime?                   @map("closed_at")

  // Relations
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]
  suggestions ChatSuggestion[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String          @id @default(uuid())
  conversationId String          @map("conversation_id")
  role           ChatMessageRole
  content        String
  createdAt      DateTime        @default(now()) @map("created_at")

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  suggestions  ChatSuggestion[]

  @@index([conversationId])
  @@map("chat_messages")
}

model ChatSuggestion {
  id               String               @id @default(uuid())
  conversationId   String               @map("conversation_id")
  messageId        String?              @map("message_id")
  suggestionType   ChatSuggestionType   @map("suggestion_type")
  targetType       String?              @map("target_type") // file, test_case, script
  targetId         String?              @map("target_id")
  targetPath       String?              @map("target_path")
  originalContent  String?              @map("original_content")
  suggestedContent String               @map("suggested_content")
  description      String?
  status           ChatSuggestionStatus @default(pending)
  acknowledgedById String?              @map("acknowledged_by_id")
  acknowledgedAt   DateTime?            @map("acknowledged_at")
  createdAt        DateTime             @default(now()) @map("created_at")

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      ChatMessage?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([messageId])
  @@index([status])
  @@map("chat_suggestions")
}

model HelpFeedback {
  id            String             @id @default(uuid())
  userId        String?            @map("user_id")
  feedbackType  HelpFeedbackType   @map("feedback_type")
  pageContext   String?            @map("page_context")
  content       String
  screenshotUrl String?            @map("screenshot_url")
  status        HelpFeedbackStatus @default(new_feedback)
  createdAt     DateTime           @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([feedbackType])
  @@index([status])
  @@map("help_feedback")
}

// =============================================================================
// AUDIT LOGS
// =============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String // Action performed
  entityType String   @map("entity_type") // Table/entity name
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
