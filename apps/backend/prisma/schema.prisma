// TestForge Database Schema
// Using Prisma with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USERS & AUTH
// =============================================================================

enum UserRole {
  admin
  lead
  qae
  dev
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         UserRole @default(qae)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  createdProjects       Project[]            @relation("ProjectCreator")
  createdTestCases      TestCase[]           @relation("TestCaseCreator")
  createdScripts        Script[]             @relation("ScriptCreator")
  triggeredExecutions   Execution[]          @relation("ExecutionTriggerer")
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]
  scriptSmithSessions   ScriptSmithSession[]
  quarantinedFlakyTests FlakyTest[]          @relation("FlakyQuarantiner")
  fixedFlakyTests       FlakyTest[]          @relation("FlakyFixer")
  chatConversations     ChatConversation[]
  helpFeedback          HelpFeedback[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// =============================================================================
// PROJECTS
// =============================================================================

enum Framework {
  playwright
  cypress
}

enum Language {
  typescript
  javascript
}

model Project {
  id            String    @id @default(uuid())
  name          String
  description   String?
  repositoryUrl String?   @map("repository_url")
  framework     Framework @default(playwright)
  language      Language  @default(typescript)
  createdById   String    @map("created_by_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  createdBy            User                  @relation("ProjectCreator", fields: [createdById], references: [id])
  requirements         Requirement[]
  testCases            TestCase[]
  testSuites           TestSuite[]
  scripts              Script[]
  environments         Environment[]
  devices              Device[]
  executions           Execution[]
  bugs                 Bug[]
  aiUsage              AiUsage[]
  scriptSmithSessions  ScriptSmithSession[]
  flakyTests           FlakyTest[]
  flakyPatterns        FlakyPattern[]
  duplicateChecks      DuplicateCheck[]
  jenkinsIntegrations  JenkinsIntegration[]
  reports              Report[]
  reportTemplates      ReportTemplate[]
  reportSchedules      ReportSchedule[]
  qualityGates         QualityGate[]
  artifacts            Artifact[]
  approvalSettings     ApprovalSettings?

  @@map("projects")
}

// =============================================================================
// REQUIREMENTS
// =============================================================================

enum Priority {
  low
  medium
  high
  critical
}

enum Status {
  active
  inactive
  archived
}

model Requirement {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  externalId  String?  @map("external_id") // Jira/external system ID
  title       String
  description String?
  priority    Priority @default(medium)
  status      Status   @default(active)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCases TestCase[]

  @@index([projectId])
  @@index([externalId])
  @@map("requirements")
}

// =============================================================================
// TEST CASES
// =============================================================================

enum TestType {
  functional
  integration
  e2e
  api
  performance
}

model TestCase {
  id             String   @id @default(uuid())
  projectId      String   @map("project_id")
  requirementId  String?  @map("requirement_id")
  title          String
  description    String?
  preconditions  String?
  steps          Json     @default("[]") // Array of TestStep
  expectedResult String?  @map("expected_result")
  testData       Json?    @map("test_data")
  priority       Priority @default(medium)
  status         Status   @default(active)
  type           TestType @default(functional)
  isAutomated    Boolean  @default(false) @map("is_automated")
  createdById    String   @map("created_by_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requirement Requirement?      @relation(fields: [requirementId], references: [id], onDelete: SetNull)
  createdBy   User              @relation("TestCaseCreator", fields: [createdById], references: [id])
  scripts     Script[]
  suites      TestSuiteCase[]
  results     ExecutionResult[]
  bugs        Bug[]
  flakyTests  FlakyTest[]

  @@index([projectId])
  @@index([requirementId])
  @@map("test_cases")
}

// =============================================================================
// TEST SUITES
// =============================================================================

model TestSuite {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCases  TestSuiteCase[]
  executions Execution[]

  @@index([projectId])
  @@map("test_suites")
}

model TestSuiteCase {
  suiteId    String @map("suite_id")
  testCaseId String @map("test_case_id")
  orderIndex Int    @default(0) @map("order_index")

  // Relations
  suite    TestSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  testCase TestCase  @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@id([suiteId, testCaseId])
  @@map("test_suite_cases")
}

// =============================================================================
// SCRIPTS
// =============================================================================

enum ScriptStatus {
  draft
  review
  approved
  deprecated
}

model Script {
  id          String       @id @default(uuid())
  testCaseId  String       @map("test_case_id")
  projectId   String       @map("project_id")
  name        String
  code        String
  language    Language     @default(typescript)
  framework   Framework    @default(playwright)
  version     Int          @default(1)
  status      ScriptStatus @default(draft)
  generatedBy String?      @map("generated_by") // 'scriptsmith', 'manual', 'framework_agent'
  createdById String       @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  testCase   TestCase          @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy  User              @relation("ScriptCreator", fields: [createdById], references: [id])
  results    ExecutionResult[]
  flakyTests FlakyTest[]

  @@index([testCaseId])
  @@index([projectId])
  @@map("scripts")
}

// =============================================================================
// ENVIRONMENTS & DEVICES
// =============================================================================

model Environment {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  name      String
  baseUrl   String   @map("base_url")
  variables Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  executions Execution[]

  @@index([projectId])
  @@map("environments")
}

enum DeviceType {
  browser
  mobile
  tablet
}

model Device {
  id        String     @id @default(uuid())
  projectId String     @map("project_id")
  name      String
  type      DeviceType
  config    Json // Browser/device configuration
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("devices")
}

// =============================================================================
// EXECUTIONS
// =============================================================================

enum ExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

enum TriggerType {
  manual
  scheduled
  ci
}

model Execution {
  id            String          @id @default(uuid())
  projectId     String          @map("project_id")
  suiteId       String?         @map("suite_id")
  environmentId String?         @map("environment_id")
  status        ExecutionStatus @default(pending)
  triggerType   TriggerType     @default(manual) @map("trigger_type")
  startedAt     DateTime?       @map("started_at")
  completedAt   DateTime?       @map("completed_at")
  summary       Json? // Execution summary stats
  triggeredById String?         @map("triggered_by_id")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  project                Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  suite                  TestSuite?              @relation(fields: [suiteId], references: [id], onDelete: SetNull)
  environment            Environment?            @relation(fields: [environmentId], references: [id])
  triggeredBy            User?                   @relation("ExecutionTriggerer", fields: [triggeredById], references: [id])
  results                ExecutionResult[]
  reports                Report[]
  qualityGateEvaluations QualityGateEvaluation[]

  @@index([projectId])
  @@index([suiteId])
  @@map("executions")
}

enum ResultStatus {
  passed
  failed
  skipped
  error
}

model ExecutionResult {
  id                 String       @id @default(uuid())
  executionId        String       @map("execution_id")
  testCaseId         String?      @map("test_case_id")
  scriptId           String?      @map("script_id")
  status             ResultStatus
  durationMs         Int?         @map("duration_ms")
  errorMessage       String?      @map("error_message")
  errorStack         String?      @map("error_stack")
  screenshots        Json         @default("[]")
  videoUrl           String?      @map("video_url")
  logs               String?
  selfHealingApplied Boolean      @default(false) @map("self_healing_applied")
  createdAt          DateTime     @default(now()) @map("created_at")

  // Relations
  execution Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  testCase  TestCase? @relation(fields: [testCaseId], references: [id])
  script    Script?   @relation(fields: [scriptId], references: [id])

  @@index([executionId])
  @@map("execution_results")
}

// =============================================================================
// BUGS
// =============================================================================

enum BugStatus {
  open
  in_progress
  resolved
  closed
  wont_fix
}

model Bug {
  id                String    @id @default(uuid())
  projectId         String    @map("project_id")
  externalId        String?   @map("external_id") // Bugzilla ID
  title             String
  description       String?
  status            BugStatus @default(open)
  priority          Priority?
  linkedTestCaseId  String?   @map("linked_test_case_id")
  linkedExecutionId String?   @map("linked_execution_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCase TestCase? @relation(fields: [linkedTestCaseId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([externalId])
  @@map("bugs")
}

// =============================================================================
// AI COST TRACKING
// =============================================================================

model AiUsage {
  id           String   @id @default(uuid())
  projectId    String   @map("project_id")
  userId       String?  @map("user_id")
  agent        String // Agent name
  operation    String // Operation performed
  model        String // Model used
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  cachedTokens Int      @default(0) @map("cached_tokens")
  costUsd      Decimal  @map("cost_usd") @db.Decimal(10, 6)
  costInr      Decimal  @map("cost_inr") @db.Decimal(10, 4)
  durationMs   Int?     @map("duration_ms")
  success      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@map("ai_usage")
}

// =============================================================================
// SCRIPTSMITH SESSIONS (Sprint 13)
// =============================================================================

enum ScriptSmithInputMethod {
  record
  upload
  screenshot
  describe
  edit
}

enum ScriptSmithSessionStatus {
  created
  input_received
  analyzing
  transforming
  reviewing
  completed
  failed
}

enum ScriptSmithFileType {
  test
  page_object
  utility
  fixture
}

model ScriptSmithSession {
  id                String                   @id @default(uuid())
  userId            String                   @map("user_id")
  projectId         String?                  @map("project_id")
  inputMethod       ScriptSmithInputMethod   @map("input_method")
  status            ScriptSmithSessionStatus @default(created)
  rawInput          Json?                    @map("raw_input")
  transformedScript String?                  @map("transformed_script")
  frameworkAnalysis Json?                    @map("framework_analysis")
  costEstimate      Decimal?                 @map("cost_estimate") @db.Decimal(10, 4)
  projectPath       String?                  @map("project_path")
  deviceType        String?                  @map("device_type")
  deviceConfig      Json?                    @map("device_config")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")
  completedAt       DateTime?                @map("completed_at")

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  files           ScriptSmithFile[]
  duplicateChecks DuplicateCheck[]

  @@index([userId])
  @@index([status])
  @@index([projectId])
  @@map("scriptsmith_sessions")
}

model ScriptSmithFile {
  id        String              @id @default(uuid())
  sessionId String              @map("session_id")
  filePath  String              @map("file_path")
  fileType  ScriptSmithFileType @map("file_type")
  content   String
  imports   String[]            @default([])
  exports   String[]            @default([])
  createdAt DateTime            @default(now()) @map("created_at")

  // Relations
  session ScriptSmithSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("scriptsmith_files")
}

// =============================================================================
// WORKFLOW EXECUTIONS (Sprint 12 - TestPilot)
// =============================================================================

enum WorkflowExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

model Workflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  steps       Json // Workflow step definitions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  executions WorkflowExecution[]

  @@map("workflows")
}

model WorkflowExecution {
  id           String                  @id @default(uuid())
  workflowId   String                  @map("workflow_id")
  status       WorkflowExecutionStatus @default(pending)
  input        Json?
  output       Json?
  error        String?
  totalCostUsd Decimal?                @map("total_cost_usd") @db.Decimal(10, 4)
  startedAt    DateTime?               @map("started_at")
  completedAt  DateTime?               @map("completed_at")
  createdAt    DateTime                @default(now()) @map("created_at")

  // Relations
  workflow Workflow                @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  steps    WorkflowExecutionStep[]

  @@index([workflowId])
  @@index([status])
  @@map("workflow_executions")
}

model WorkflowExecutionStep {
  id          String    @id @default(uuid())
  executionId String    @map("execution_id")
  stepId      String    @map("step_id")
  status      String
  input       Json?
  output      Json?
  error       String?
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  execution WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@map("workflow_execution_steps")
}

// =============================================================================
// FLAKY TESTS (Sprint 14)
// =============================================================================

enum FlakyPatternType {
  timing
  race_condition
  flaky_selector
  network
  state_dependent
  environment
  data_dependent
  unknown
}

enum FlakyFixStatus {
  open
  investigating
  fixed
  wont_fix
}

model FlakyTest {
  id                String          @id @default(uuid())
  projectId         String          @map("project_id")
  testCaseId        String?         @map("test_case_id")
  scriptId          String?         @map("script_id")
  testName          String          @map("test_name")
  flakinessScore    Decimal         @default(0) @map("flakiness_score") @db.Decimal(5, 2) // 0-100
  totalRuns         Int             @default(0) @map("total_runs")
  passCount         Int             @default(0) @map("pass_count")
  failCount         Int             @default(0) @map("fail_count")
  lastPassAt        DateTime?       @map("last_pass_at")
  lastFailAt        DateTime?       @map("last_fail_at")
  isQuarantined     Boolean         @default(false) @map("is_quarantined")
  quarantinedAt     DateTime?       @map("quarantined_at")
  quarantinedById   String?         @map("quarantined_by_id")
  quarantineReason  String?         @map("quarantine_reason")
  patternType       FlakyPatternType? @map("pattern_type")
  rootCauseAnalysis Json?           @map("root_cause_analysis")
  fixStatus         FlakyFixStatus  @default(open) @map("fix_status")
  fixedAt           DateTime?       @map("fixed_at")
  fixedById         String?         @map("fixed_by_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCase      TestCase? @relation(fields: [testCaseId], references: [id], onDelete: SetNull)
  script        Script?   @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  quarantinedBy User?     @relation("FlakyQuarantiner", fields: [quarantinedById], references: [id])
  fixedBy       User?     @relation("FlakyFixer", fields: [fixedById], references: [id])

  @@unique([projectId, testCaseId, scriptId])
  @@index([projectId])
  @@index([flakinessScore(sort: Desc)])
  @@index([isQuarantined])
  @@index([fixStatus])
  @@map("flaky_tests")
}

enum FlakyPatternSeverity {
  critical
  high
  medium
  low
}

model FlakyPattern {
  id              String               @id @default(uuid())
  projectId       String               @map("project_id")
  patternType     FlakyPatternType     @map("pattern_type")
  description     String
  severity        FlakyPatternSeverity
  affectedTestIds String[]             @map("affected_test_ids")
  confidence      Decimal              @db.Decimal(5, 2) // 0-100
  suggestedFix    String?              @map("suggested_fix")
  detectedAt      DateTime             @default(now()) @map("detected_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([patternType])
  @@map("flaky_patterns")
}

// =============================================================================
// DUPLICATE DETECTION (Sprint 14)
// =============================================================================

enum DuplicateSourceType {
  test_case
  script
  session
}

enum DuplicateMatchType {
  exact
  near
  semantic
}

model DuplicateCheck {
  id           String               @id @default(uuid())
  projectId    String               @map("project_id")
  sessionId    String?              @map("session_id")
  sourceType   DuplicateSourceType  @map("source_type")
  sourceId     String               @map("source_id")
  contentHash  String?              @map("content_hash") // For exact match detection
  isDuplicate  Boolean              @default(false) @map("is_duplicate")
  confidence   Decimal?             @db.Decimal(5, 2) // 0-100
  matchType    DuplicateMatchType?  @map("match_type")
  similarItems Json?                @map("similar_items") // [{id, name, similarity, path}]
  reason       String?
  checkedAt    DateTime             @default(now()) @map("checked_at")

  // Relations
  project Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  session ScriptSmithSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([sourceType, sourceId])
  @@index([contentHash])
  @@map("duplicate_checks")
}

// =============================================================================
// JENKINS INTEGRATION (Sprint 15)
// =============================================================================

enum JenkinsBuildStatus {
  pending
  building
  success
  failure
  aborted
}

model JenkinsIntegration {
  id                  String   @id @default(uuid())
  projectId           String   @map("project_id")
  integrationName     String   @map("integration_name")
  serverUrl           String   @map("server_url")
  username            String
  apiTokenEncrypted   String   @map("api_token_encrypted") // AES-256 encrypted
  jobPath             String   @map("job_path")
  defaultEnvironment  String?  @map("default_environment")
  defaultBrowser      String?  @map("default_browser")
  buildParameters     Json?    @map("build_parameters")
  isActive            Boolean  @default(true) @map("is_active")
  createdById         String?  @map("created_by_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project  Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  builds   JenkinsBuild[]

  @@index([projectId])
  @@map("jenkins_integrations")
}

model JenkinsBuild {
  id                 String             @id @default(uuid())
  integrationId      String             @map("integration_id")
  executionId        String?            @map("execution_id")
  jenkinsBuildNumber Int                @map("jenkins_build_number")
  jenkinsBuildUrl    String             @map("jenkins_build_url")
  status             JenkinsBuildStatus @default(pending)
  parameters         Json?
  startedAt          DateTime?          @map("started_at")
  completedAt        DateTime?          @map("completed_at")
  durationMs         Int?               @map("duration_ms")
  totalTests         Int?               @map("total_tests")
  passedTests        Int?               @map("passed_tests")
  failedTests        Int?               @map("failed_tests")
  consoleLogUrl      String?            @map("console_log_url")
  createdAt          DateTime           @default(now()) @map("created_at")

  // Relations
  integration JenkinsIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([executionId])
  @@index([status])
  @@map("jenkins_builds")
}

// =============================================================================
// CHAT SYSTEM (Sprint 16)
// =============================================================================

enum ChatConversationStatus {
  active
  closed
  archived
}

enum ChatMessageRole {
  user
  assistant
  system
}

enum ChatSuggestionType {
  code_change
  config_change
  test_case
  script
  fix_suggestion
  explanation
  navigation
}

enum ChatSuggestionStatus {
  pending
  acknowledged
  dismissed
}

enum ChatConversationCategory {
  help_question
  feature_request
  bug_report
}

enum HelpFeedbackType {
  bug
  feature
  question
  other
}

enum HelpFeedbackStatus {
  new_feedback
  reviewed
  resolved
}

model ChatConversation {
  id          String                      @id @default(uuid())
  userId      String                      @map("user_id")
  projectId   String?                     @map("project_id")
  contextType String?                     @map("context_type") // page, test_case, script, etc.
  contextId   String?                     @map("context_id")
  title       String?
  category    ChatConversationCategory    @default(help_question)
  status      ChatConversationStatus      @default(active)
  createdAt   DateTime                    @default(now()) @map("created_at")
  updatedAt   DateTime                    @updatedAt @map("updated_at")
  closedAt    DateTime?                   @map("closed_at")

  // Relations
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]
  suggestions ChatSuggestion[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String          @id @default(uuid())
  conversationId String          @map("conversation_id")
  role           ChatMessageRole
  content        String
  createdAt      DateTime        @default(now()) @map("created_at")

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  suggestions  ChatSuggestion[]

  @@index([conversationId])
  @@map("chat_messages")
}

model ChatSuggestion {
  id               String               @id @default(uuid())
  conversationId   String               @map("conversation_id")
  messageId        String?              @map("message_id")
  suggestionType   ChatSuggestionType   @map("suggestion_type")
  targetType       String?              @map("target_type") // file, test_case, script
  targetId         String?              @map("target_id")
  targetPath       String?              @map("target_path")
  originalContent  String?              @map("original_content")
  suggestedContent String               @map("suggested_content")
  description      String?
  status           ChatSuggestionStatus @default(pending)
  acknowledgedById String?              @map("acknowledged_by_id")
  acknowledgedAt   DateTime?            @map("acknowledged_at")
  createdAt        DateTime             @default(now()) @map("created_at")

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message      ChatMessage?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([messageId])
  @@index([status])
  @@map("chat_suggestions")
}

model HelpFeedback {
  id            String             @id @default(uuid())
  userId        String?            @map("user_id")
  feedbackType  HelpFeedbackType   @map("feedback_type")
  pageContext   String?            @map("page_context")
  content       String
  screenshotUrl String?            @map("screenshot_url")
  status        HelpFeedbackStatus @default(new_feedback)
  createdAt     DateTime           @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([feedbackType])
  @@index([status])
  @@map("help_feedback")
}

// =============================================================================
// REPORTS (Sprint 17)
// =============================================================================

enum ReportType {
  execution_summary
  coverage
  flaky_analysis
  trend
  ai_cost
  custom
}

enum ReportFormat {
  pdf
  excel
  json
}

enum ReportStatus {
  pending
  generating
  completed
  failed
}

model Report {
  id          String       @id @default(uuid())
  projectId   String       @map("project_id")
  executionId String?      @map("execution_id")
  templateId  String?      @map("template_id")
  type        ReportType
  format      ReportFormat @default(pdf)
  status      ReportStatus @default(pending)
  title       String
  description String?
  parameters  Json?
  data        Json?
  filePath    String?      @map("file_path")
  fileSize    Int?         @map("file_size")
  generatedAt DateTime?    @map("generated_at")
  expiresAt   DateTime?    @map("expires_at")
  error       String?
  createdById String?      @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")

  // Relations
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  execution Execution?      @relation(fields: [executionId], references: [id], onDelete: SetNull)
  template  ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  schedule  ReportSchedule?

  @@index([projectId])
  @@index([executionId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

model ReportTemplate {
  id          String     @id @default(uuid())
  projectId   String     @map("project_id")
  name        String
  description String?
  type        ReportType
  config      Json
  isDefault   Boolean    @default(false) @map("is_default")
  createdById String?    @map("created_by_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reports   Report[]
  schedules ReportSchedule[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([type])
  @@map("report_templates")
}

model ReportSchedule {
  id             String       @id @default(uuid())
  reportId       String?      @unique @map("report_id")
  templateId     String       @map("template_id")
  projectId      String       @map("project_id")
  name           String
  cronExpression String       @map("cron_expression")
  timezone       String       @default("UTC")
  format         ReportFormat @default(pdf)
  parameters     Json?
  recipients     String[]     @default([])
  isActive       Boolean      @default(true) @map("is_active")
  lastRunAt      DateTime?    @map("last_run_at")
  nextRunAt      DateTime?    @map("next_run_at")
  createdById    String?      @map("created_by_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  template   ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  project    Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lastReport Report?        @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("report_schedules")
}

// =============================================================================
// QUALITY GATES (Sprint 17)
// =============================================================================

enum QualityGateMetric {
  pass_rate
  coverage
  flakiness
  duration
  failed_count
  critical_failures
}

enum QualityGateStatus {
  passed
  failed
  warning
  skipped
}

model QualityGate {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  description String?
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  failOnBreach Boolean @default(true) @map("fail_on_breach")
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  conditions  QualityGateCondition[]
  evaluations QualityGateEvaluation[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([isDefault])
  @@map("quality_gates")
}

model QualityGateCondition {
  id            String            @id @default(uuid())
  qualityGateId String            @map("quality_gate_id")
  metric        QualityGateMetric
  operator      String
  threshold     Decimal           @db.Decimal(10, 2)
  severity      String            @default("error")
  description   String?
  orderIndex    Int               @default(0) @map("order_index")
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relations
  qualityGate QualityGate @relation(fields: [qualityGateId], references: [id], onDelete: Cascade)

  @@index([qualityGateId])
  @@map("quality_gate_conditions")
}

model QualityGateEvaluation {
  id            String            @id @default(uuid())
  qualityGateId String            @map("quality_gate_id")
  executionId   String            @map("execution_id")
  projectId     String            @map("project_id")
  status        QualityGateStatus
  results       Json
  summary       String?
  evaluatedAt   DateTime          @default(now()) @map("evaluated_at")

  // Relations
  qualityGate QualityGate @relation(fields: [qualityGateId], references: [id], onDelete: Cascade)
  execution   Execution   @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@unique([qualityGateId, executionId])
  @@index([executionId])
  @@index([projectId])
  @@index([status])
  @@map("quality_gate_evaluations")
}

// =============================================================================
// AUDIT LOGS
// =============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String // Action performed
  entityType String   @map("entity_type") // Table/entity name
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// HITL APPROVAL WORKFLOWS (Sprint 18)
// =============================================================================

enum ArtifactType {
  test_case
  script
  bug_analysis
  chat_suggestion
  self_healing_fix
}

enum RiskLevel {
  low
  medium
  high
  critical
}

enum ArtifactState {
  draft
  pending_review
  in_review
  approved
  rejected
  archived
}

enum SLAStatus {
  within_sla
  approaching_sla
  breached
  escalated
}

enum RejectionCategory {
  accuracy
  incomplete
  style_violation
  security_concern
  performance
  scope_creep
  duplicate
  other
}

model Artifact {
  id                String        @id @default(uuid())
  projectId         String        @map("project_id")
  type              ArtifactType
  state             ArtifactState @default(draft)
  riskLevel         RiskLevel     @map("risk_level")
  sourceAgent       String        @map("source_agent")
  sourceSessionId   String?       @map("source_session_id")
  sourceType        String?       @map("source_type")
  title             String
  description       String?
  content           Json
  metadata          Json?
  riskScore         Decimal       @map("risk_score") @db.Decimal(5, 2)
  riskFactors       Json?         @map("risk_factors")
  aiConfidenceScore Decimal?      @map("ai_confidence_score") @db.Decimal(5, 2)
  targetEntityType  String?       @map("target_entity_type")
  targetEntityId    String?       @map("target_entity_id")
  submittedAt       DateTime?     @map("submitted_at")
  approvedAt        DateTime?     @map("approved_at")
  rejectedAt        DateTime?     @map("rejected_at")
  archivedAt        DateTime?     @map("archived_at")
  createdById       String        @map("created_by_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  version           Int           @default(1)
  previousVersionId String?       @map("previous_version_id")

  // Relations
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  previousVersion Artifact?         @relation("ArtifactVersions", fields: [previousVersionId], references: [id])
  newVersions     Artifact[]        @relation("ArtifactVersions")
  workflow        ApprovalWorkflow?
  slaTracking     SLATracking?
  history         ArtifactHistory[]
  feedback        ApprovalFeedback[]

  @@index([projectId])
  @@index([type])
  @@index([state])
  @@index([riskLevel])
  @@index([createdById])
  @@index([submittedAt])
  @@map("artifacts")
}

model ApprovalWorkflow {
  id                String    @id @default(uuid())
  artifactId        String    @unique @map("artifact_id")
  requiredApprovals Int       @default(1) @map("required_approvals")
  currentApprovals  Int       @default(0) @map("current_approvals")
  requiresAdmin     Boolean   @default(false) @map("requires_admin")
  requiresLead      Boolean   @default(false) @map("requires_lead")
  autoApproved      Boolean   @default(false) @map("auto_approved")
  autoApproveReason String?   @map("auto_approve_reason")
  startedAt         DateTime  @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")

  // Relations
  artifact Artifact       @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  steps    ApprovalStep[]

  @@index([artifactId])
  @@map("approval_workflows")
}

model ApprovalStep {
  id           String    @id @default(uuid())
  workflowId   String    @map("workflow_id")
  stepOrder    Int       @map("step_order")
  requiredRole UserRole? @map("required_role")
  assignedToId String?   @map("assigned_to_id")
  status       String    @default("pending")
  actionById   String?   @map("action_by_id")
  actionAt     DateTime? @map("action_at")
  comment      String?

  // Relations
  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([assignedToId])
  @@index([status])
  @@map("approval_steps")
}

model SLATracking {
  id               String    @id @default(uuid())
  artifactId       String    @unique @map("artifact_id")
  riskLevel        RiskLevel @map("risk_level")
  deadlineHours    Int       @map("deadline_hours")
  deadline         DateTime
  status           SLAStatus @default(within_sla)
  warningThreshold Int       @default(75) @map("warning_threshold")
  warningSentAt    DateTime? @map("warning_sent_at")
  escalatedAt      DateTime? @map("escalated_at")
  escalatedToId    String?   @map("escalated_to_id")
  escalationReason String?   @map("escalation_reason")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([artifactId])
  @@index([deadline])
  @@index([status])
  @@map("sla_tracking")
}

model ArtifactHistory {
  id         String         @id @default(uuid())
  artifactId String         @map("artifact_id")
  fromState  ArtifactState? @map("from_state")
  toState    ArtifactState  @map("to_state")
  action     String
  actionById String?        @map("action_by_id")
  actionAt   DateTime       @default(now()) @map("action_at")
  comment    String?
  metadata   Json?

  // Relations
  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([artifactId])
  @@index([actionAt])
  @@map("artifact_history")
}

model ApprovalFeedback {
  id               String            @id @default(uuid())
  artifactId       String            @map("artifact_id")
  category         RejectionCategory
  severity         String
  description      String
  suggestedFix     String?           @map("suggested_fix")
  affectedSection  String?           @map("affected_section")
  correctedContent String?           @map("corrected_content")
  createdById      String            @map("created_by_id")
  createdAt        DateTime          @default(now()) @map("created_at")

  // Relations
  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([artifactId])
  @@index([category])
  @@index([createdAt])
  @@map("approval_feedback")
}

model ApprovalSettings {
  id                       String    @id @default(uuid())
  projectId                String    @unique @map("project_id")
  lowRiskThreshold         Decimal   @default(25) @map("low_risk_threshold") @db.Decimal(5, 2)
  mediumRiskThreshold      Decimal   @default(50) @map("medium_risk_threshold") @db.Decimal(5, 2)
  highRiskThreshold        Decimal   @default(75) @map("high_risk_threshold") @db.Decimal(5, 2)
  lowRiskSlaHours          Int       @default(1) @map("low_risk_sla_hours")
  mediumRiskSlaHours       Int       @default(4) @map("medium_risk_sla_hours")
  highRiskSlaHours         Int       @default(24) @map("high_risk_sla_hours")
  criticalRiskSlaHours     Int       @default(48) @map("critical_risk_sla_hours")
  autoApproveEnabled       Boolean   @default(true) @map("auto_approve_enabled")
  autoApproveMaxRisk       RiskLevel @default(low) @map("auto_approve_max_risk")
  autoApproveMinConfidence Decimal   @default(90) @map("auto_approve_min_confidence") @db.Decimal(5, 2)
  notifyOnSubmission       Boolean   @default(true) @map("notify_on_submission")
  notifyOnApproval         Boolean   @default(true) @map("notify_on_approval")
  notifyOnRejection        Boolean   @default(true) @map("notify_on_rejection")
  notifyOnSlaWarning       Boolean   @default(true) @map("notify_on_sla_warning")
  escalationEnabled        Boolean   @default(true) @map("escalation_enabled")
  escalationChain          String[]  @default([]) @map("escalation_chain")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("approval_settings")
}

// =============================================================================
// TEAMS (Sprint 19)
// =============================================================================

model Team {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members        TeamMember[]
  projectAccess  TeamProjectAccess[]

  @@map("teams")
}

enum TeamMemberRole {
  owner
  admin
  member
}

model TeamMember {
  id        String         @id @default(uuid())
  teamId    String         @map("team_id")
  userId    String         @map("user_id")
  role      TeamMemberRole @default(member)
  joinedAt  DateTime       @default(now()) @map("joined_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

enum TeamAccessLevel {
  read
  write
  admin
}

model TeamProjectAccess {
  id          String          @id @default(uuid())
  teamId      String          @map("team_id")
  projectId   String          @map("project_id")
  accessLevel TeamAccessLevel @default(read) @map("access_level")
  grantedAt   DateTime        @default(now()) @map("granted_at")
  grantedById String?         @map("granted_by_id")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([teamId])
  @@index([projectId])
  @@map("team_project_access")
}

// =============================================================================
// RBAC/PERMISSIONS (Sprint 19)
// =============================================================================

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  resource    String   // e.g., 'project', 'test_case', 'script'
  action      String   // e.g., 'create', 'read', 'update', 'delete'
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system") // System roles cannot be deleted
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  permissions RolePermission[]
  userRoles   UserRoleAssignment[]

  @@map("roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  roleId     String    @map("role_id")
  projectId  String?   @map("project_id") // null = global role, non-null = project-specific
  assignedAt DateTime  @default(now()) @map("assigned_at")
  assignedBy String?   @map("assigned_by")
  expiresAt  DateTime? @map("expires_at")

  // Relations
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, projectId])
  @@index([userId])
  @@index([roleId])
  @@index([projectId])
  @@map("user_role_assignments")
}

model UserPermission {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  permissionId String    @map("permission_id")
  projectId    String?   @map("project_id") // null = global permission
  isGranted    Boolean   @default(true) @map("is_granted") // false = explicit deny
  grantedAt    DateTime  @default(now()) @map("granted_at")
  grantedBy    String?   @map("granted_by")
  expiresAt    DateTime? @map("expires_at")

  // Relations
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, projectId])
  @@index([userId])
  @@index([permissionId])
  @@index([projectId])
  @@map("user_permissions")
}

// =============================================================================
// ENHANCED AUDIT LOGGING (Sprint 19)
// =============================================================================

enum AuditSeverity {
  info
  warning
  critical
}

enum AuditCategory {
  authentication
  authorization
  data_access
  data_modification
  system
  security
}

model AuditLogEnhanced {
  id           String        @id @default(uuid())
  userId       String?       @map("user_id")
  sessionId    String?       @map("session_id")
  action       String
  category     AuditCategory
  severity     AuditSeverity @default(info)
  resource     String        // e.g., 'project', 'test_case'
  resourceId   String?       @map("resource_id")
  projectId    String?       @map("project_id")
  description  String?
  oldValue     Json?         @map("old_value")
  newValue     Json?         @map("new_value")
  metadata     Json?
  ipAddress    String?       @map("ip_address")
  userAgent    String?       @map("user_agent")
  requestId    String?       @map("request_id")
  durationMs   Int?          @map("duration_ms")
  success      Boolean       @default(true)
  errorMessage String?       @map("error_message")
  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([userId])
  @@index([category])
  @@index([severity])
  @@index([resource, resourceId])
  @@index([projectId])
  @@index([createdAt])
  @@index([sessionId])
  @@map("audit_logs_enhanced")
}

// =============================================================================
// WEBSOCKET CONNECTIONS (Sprint 19)
// =============================================================================

enum WebSocketConnectionStatus {
  connected
  disconnected
  idle
}

model WebSocketConnection {
  id           String                    @id @default(uuid())
  socketId     String                    @unique @map("socket_id")
  userId       String                    @map("user_id")
  status       WebSocketConnectionStatus @default(connected)
  connectedAt  DateTime                  @default(now()) @map("connected_at")
  lastPingAt   DateTime?                 @map("last_ping_at")
  disconnectedAt DateTime?               @map("disconnected_at")
  userAgent    String?                   @map("user_agent")
  ipAddress    String?                   @map("ip_address")
  metadata     Json?

  // Relations - subscriptions to specific resources
  subscriptions WebSocketSubscription[]

  @@index([userId])
  @@index([status])
  @@index([connectedAt])
  @@map("websocket_connections")
}

model WebSocketSubscription {
  id           String   @id @default(uuid())
  connectionId String   @map("connection_id")
  channel      String   // e.g., 'execution:123', 'project:456'
  subscribedAt DateTime @default(now()) @map("subscribed_at")

  // Relations
  connection WebSocketConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, channel])
  @@index([connectionId])
  @@index([channel])
  @@map("websocket_subscriptions")
}

// =============================================================================
// EXECUTIVE DASHBOARD (Sprint 19)
// =============================================================================

enum MetricType {
  count
  percentage
  duration
  score
  trend
}

enum MetricPeriod {
  hourly
  daily
  weekly
  monthly
}

model DashboardMetric {
  id          String       @id @default(uuid())
  projectId   String?      @map("project_id") // null = global metric
  name        String
  type        MetricType
  value       Decimal      @db.Decimal(15, 4)
  previousValue Decimal?   @map("previous_value") @db.Decimal(15, 4)
  changePercent Decimal?   @map("change_percent") @db.Decimal(10, 2)
  period      MetricPeriod
  periodStart DateTime     @map("period_start")
  periodEnd   DateTime     @map("period_end")
  metadata    Json?
  createdAt   DateTime     @default(now()) @map("created_at")

  @@index([projectId])
  @@index([name])
  @@index([period])
  @@index([periodStart, periodEnd])
  @@map("dashboard_metrics")
}

model DashboardSnapshot {
  id          String   @id @default(uuid())
  projectId   String?  @map("project_id") // null = global snapshot
  snapshotAt  DateTime @map("snapshot_at")
  data        Json     // Full dashboard state at snapshot time
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([projectId])
  @@index([snapshotAt])
  @@map("dashboard_snapshots")
}
